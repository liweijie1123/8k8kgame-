JSNES.Mappers={},JSNES.Mappers[0]=function(e){this.nes=e},JSNES.Mappers[0].prototype={reset:function(){this.joy1StrobeState=0,this.joy2StrobeState=0,this.joypadLastWrite=0,this.mousePressed=!1,this.mouseX=null,this.mouseY=null},write:function(e,t){e<8192?this.nes.cpu.mem[2047&e]=t:16407<e?this.nes.cpu.mem[e]=t:8199<e&&e<16384?this.regWrite(8192+(7&e),t):this.regWrite(e,t)},writelow:function(e,t){e<8192?this.nes.cpu.mem[2047&e]=t:16407<e?this.nes.cpu.mem[e]=t:8199<e&&e<16384?this.regWrite(8192+(7&e),t):this.regWrite(e,t)},load:function(e){return 16407<(e&=65535)?this.nes.cpu.mem[e]:8192<=e?this.regLoad(e):this.nes.cpu.mem[2047&e]},regLoad:function(e){switch(e>>12){case 0:case 1:break;case 2:case 3:switch(7&e){case 0:return this.nes.cpu.mem[8192];case 1:return this.nes.cpu.mem[8193];case 2:return this.nes.ppu.readStatusRegister();case 3:return 0;case 4:return this.nes.ppu.sramLoad();case 5:case 6:return 0;case 7:return this.nes.ppu.vramLoad()}break;case 4:switch(e-16405){case 0:return this.nes.papu.readReg(e);case 1:return this.joy1Read();case 2:if(this.mousePressed){for(var t=Math.max(0,this.mouseX-4),s=Math.min(256,this.mouseX+4),r=Math.max(0,this.mouseY-4),i=Math.min(240,this.mouseY+4),o=0,a=r;a<i;a++)for(var n=t;n<s;n++)if(16777215==this.nes.ppu.buffer[(a<<8)+n]){o|=8,console.debug("Clicked on white!");break}return o|=this.mousePressed?16:0,65535&(this.joy2Read()|o)}return this.joy2Read()}}return 0},regWrite:function(e,t){switch(e){case 8192:this.nes.cpu.mem[e]=t,this.nes.ppu.updateControlReg1(t);break;case 8193:this.nes.cpu.mem[e]=t,this.nes.ppu.updateControlReg2(t);break;case 8195:this.nes.ppu.writeSRAMAddress(t);break;case 8196:this.nes.ppu.sramWrite(t);break;case 8197:this.nes.ppu.scrollWrite(t);break;case 8198:this.nes.ppu.writeVRAMAddress(t);break;case 8199:this.nes.ppu.vramWrite(t);break;case 16404:this.nes.ppu.sramDMA(t);break;case 16405:this.nes.papu.writeReg(e,t);break;case 16406:0==(1&t)&&1==(1&this.joypadLastWrite)&&(this.joy1StrobeState=0,this.joy2StrobeState=0),this.joypadLastWrite=t;break;case 16407:this.nes.papu.writeReg(e,t);break;default:16384<=e&&e<=16407&&this.nes.papu.writeReg(e,t)}},joy1Read:function(){var e;switch(this.joy1StrobeState){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:e=this.nes.keyboard.state1[this.joy1StrobeState];break;case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:e=0;break;case 19:e=1;break;default:e=0}return this.joy1StrobeState++,24==this.joy1StrobeState&&(this.joy1StrobeState=0),e},joy2Read:function(){var e;switch(this.joy2StrobeState){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:e=this.nes.keyboard.state2[this.joy2StrobeState];break;case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:e=0;break;case 19:e=1;break;default:e=0}return this.joy2StrobeState++,24==this.joy2StrobeState&&(this.joy2StrobeState=0),e},loadROM:function(){!this.nes.rom.valid||this.nes.rom.romCount<1?alert("NoMapper: Invalid ROM! Unable to load."):(this.loadPRGROM(),this.loadCHRROM(),this.loadBatteryRam(),this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET))},loadPRGROM:function(){1<this.nes.rom.romCount?(this.loadRomBank(0,32768),this.loadRomBank(1,49152)):(this.loadRomBank(0,32768),this.loadRomBank(0,49152))},loadCHRROM:function(){0<this.nes.rom.vromCount&&(1==this.nes.rom.vromCount?(this.loadVromBank(0,0),this.loadVromBank(0,4096)):(this.loadVromBank(0,0),this.loadVromBank(1,4096)))},loadBatteryRam:function(){var e;this.nes.rom.batteryRam&&null!==(e=this.nes.rom.batteryRam)&&8192==e.length&&JSNES.Utils.copyArrayElements(e,0,this.nes.cpu.mem,24576,8192)},loadRomBank:function(e,t){e%=this.nes.rom.romCount,JSNES.Utils.copyArrayElements(this.nes.rom.rom[e],0,this.nes.cpu.mem,t,16384)},loadVromBank:function(e,t){0!==this.nes.rom.vromCount&&(this.nes.ppu.triggerRendering(),JSNES.Utils.copyArrayElements(this.nes.rom.vrom[e%this.nes.rom.vromCount],0,this.nes.ppu.vramMem,t,4096),e=this.nes.rom.vromTile[e%this.nes.rom.vromCount],JSNES.Utils.copyArrayElements(e,0,this.nes.ppu.ptTile,t>>4,256))},load32kRomBank:function(e,t){this.loadRomBank(2*e%this.nes.rom.romCount,t),this.loadRomBank((2*e+1)%this.nes.rom.romCount,t+16384)},load8kVromBank:function(e,t){0!==this.nes.rom.vromCount&&(this.nes.ppu.triggerRendering(),this.loadVromBank(e%this.nes.rom.vromCount,t),this.loadVromBank((e+1)%this.nes.rom.vromCount,t+4096))},load1kVromBank:function(e,t){if(0!==this.nes.rom.vromCount){this.nes.ppu.triggerRendering();for(var s=Math.floor(e/4)%this.nes.rom.vromCount,r=(JSNES.Utils.copyArrayElements(this.nes.rom.vrom[s],0,this.nes.ppu.vramMem,e%4*1024,1024),this.nes.rom.vromTile[s]),i=t>>4,o=0;o<64;o++)this.nes.ppu.ptTile[i+o]=r[(e%4<<6)+o]}},load2kVromBank:function(e,t){if(0!==this.nes.rom.vromCount){this.nes.ppu.triggerRendering();for(var s=Math.floor(e/2)%this.nes.rom.vromCount,r=(JSNES.Utils.copyArrayElements(this.nes.rom.vrom[s],e%2*2048,this.nes.ppu.vramMem,t,2048),this.nes.rom.vromTile[s]),i=t>>4,o=0;o<128;o++)this.nes.ppu.ptTile[i+o]=r[(e%2<<7)+o]}},load8kRomBank:function(e,t){var s=Math.floor(e/2)%this.nes.rom.romCount;JSNES.Utils.copyArrayElements(this.nes.rom.rom[s],e%2*8192,this.nes.cpu.mem,t,8192)},clockIrqCounter:function(){},latchAccess:function(e){},toJSON:function(){return{joy1StrobeState:this.joy1StrobeState,joy2StrobeState:this.joy2StrobeState,joypadLastWrite:this.joypadLastWrite}},fromJSON:function(e){this.joy1StrobeState=e.joy1StrobeState,this.joy2StrobeState=e.joy2StrobeState,this.joypadLastWrite=e.joypadLastWrite}},JSNES.Mappers[1]=function(e){this.nes=e},JSNES.Mappers[1].prototype=new JSNES.Mappers[0],JSNES.Mappers[1].prototype.reset=function(){JSNES.Mappers[0].prototype.reset.apply(this),this.regBuffer=0,this.regBufferCounter=0,this.mirroring=0,this.oneScreenMirroring=0,this.prgSwitchingArea=1,this.prgSwitchingSize=1,this.vromSwitchingSize=0,this.romSelectionReg0=0,this.romSelectionReg1=0,this.romBankSelect=0},JSNES.Mappers[1].prototype.write=function(e,t){e<32768?JSNES.Mappers[0].prototype.write.apply(this,arguments):0!=(128&t)?(this.regBufferCounter=0,(this.regBuffer=0)===this.getRegNumber(e)&&(this.prgSwitchingArea=1,this.prgSwitchingSize=1)):(this.regBuffer=this.regBuffer&255-(1<<this.regBufferCounter)|(1&t)<<this.regBufferCounter,this.regBufferCounter++,5==this.regBufferCounter&&(this.setReg(this.getRegNumber(e),this.regBuffer),this.regBuffer=0,this.regBufferCounter=0))},JSNES.Mappers[1].prototype.setReg=function(e,t){switch(e){case 0:(r=3&t)!==this.mirroring&&(this.mirroring=r,0==(2&this.mirroring)?this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING):0!=(1&this.mirroring)?this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING):this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING)),this.prgSwitchingArea=t>>2&1,this.prgSwitchingSize=t>>3&1,this.vromSwitchingSize=t>>4&1;break;case 1:this.romSelectionReg0=t>>4&1,0<this.nes.rom.vromCount&&(0===this.vromSwitchingSize?0===this.romSelectionReg0?this.load8kVromBank(15&t,0):this.load8kVromBank(Math.floor(this.nes.rom.vromCount/2)+(15&t),0):0===this.romSelectionReg0?this.loadVromBank(15&t,0):this.loadVromBank(Math.floor(this.nes.rom.vromCount/2)+(15&t),0));break;case 2:this.romSelectionReg1=t>>4&1,0<this.nes.rom.vromCount&&1===this.vromSwitchingSize&&(0===this.romSelectionReg1?this.loadVromBank(15&t,4096):this.loadVromBank(Math.floor(this.nes.rom.vromCount/2)+(15&t),4096));break;default:var s,r=15&t,r=0;32<=this.nes.rom.romCount?0===this.vromSwitchingSize?1===this.romSelectionReg0&&(r=16):r=(this.romSelectionReg0|this.romSelectionReg1<<1)<<3:16<=this.nes.rom.romCount&&1===this.romSelectionReg0&&(r=8),0===this.prgSwitchingSize?this.load32kRomBank(s=r+(15&t),32768):(s=2*r+(15&t),0===this.prgSwitchingArea?this.loadRomBank(s,49152):this.loadRomBank(s,32768))}},JSNES.Mappers[1].prototype.getRegNumber=function(e){return 32768<=e&&e<=40959?0:40960<=e&&e<=49151?1:49152<=e&&e<=57343?2:3},JSNES.Mappers[1].prototype.loadROM=function(e){this.nes.rom.valid?(this.loadRomBank(0,32768),this.loadRomBank(this.nes.rom.romCount-1,49152),this.loadCHRROM(),this.loadBatteryRam(),this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET)):alert("MMC1: Invalid ROM! Unable to load.")},JSNES.Mappers[1].prototype.switchLowHighPrgRom=function(e){},JSNES.Mappers[1].prototype.switch16to32=function(){},JSNES.Mappers[1].prototype.switch32to16=function(){},JSNES.Mappers[1].prototype.toJSON=function(){var e=JSNES.Mappers[0].prototype.toJSON.apply(this);return e.mirroring=this.mirroring,e.oneScreenMirroring=this.oneScreenMirroring,e.prgSwitchingArea=this.prgSwitchingArea,e.prgSwitchingSize=this.prgSwitchingSize,e.vromSwitchingSize=this.vromSwitchingSize,e.romSelectionReg0=this.romSelectionReg0,e.romSelectionReg1=this.romSelectionReg1,e.romBankSelect=this.romBankSelect,e.regBuffer=this.regBuffer,e.regBufferCounter=this.regBufferCounter,e},JSNES.Mappers[1].prototype.fromJSON=function(e){JSNES.Mappers[0].prototype.fromJSON.apply(this,e),this.mirroring=e.mirroring,this.oneScreenMirroring=e.oneScreenMirroring,this.prgSwitchingArea=e.prgSwitchingArea,this.prgSwitchingSize=e.prgSwitchingSize,this.vromSwitchingSize=e.vromSwitchingSize,this.romSelectionReg0=e.romSelectionReg0,this.romSelectionReg1=e.romSelectionReg1,this.romBankSelect=e.romBankSelect,this.regBuffer=e.regBuffer,this.regBufferCounter=e.regBufferCounter},JSNES.Mappers[2]=function(e){this.nes=e},JSNES.Mappers[2].prototype=new JSNES.Mappers[0],JSNES.Mappers[2].prototype.write=function(e,t){e<32768?JSNES.Mappers[0].prototype.write.apply(this,arguments):this.loadRomBank(t,32768)},JSNES.Mappers[2].prototype.loadROM=function(e){this.nes.rom.valid?(this.loadRomBank(0,32768),this.loadRomBank(this.nes.rom.romCount-1,49152),this.loadCHRROM(),this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET)):alert("UNROM: Invalid ROM! Unable to load.")},JSNES.Mappers[3]=function(e){this.nes=e},JSNES.Mappers[3].prototype=new JSNES.Mappers[0],JSNES.Mappers[3].prototype.write=function(e,t){var s;e<32768?JSNES.Mappers[0].prototype.write.apply(this,arguments):(s=t%(this.nes.rom.vromCount/2)*2,this.loadVromBank(s,0),this.loadVromBank(1+s,4096),this.load8kVromBank(2*t,0))},JSNES.Mappers[4]=function(e){this.nes=e,this.CMD_SEL_2_1K_VROM_0000=0,this.CMD_SEL_2_1K_VROM_0800=1,this.CMD_SEL_1K_VROM_1000=2,this.CMD_SEL_1K_VROM_1400=3,this.CMD_SEL_1K_VROM_1800=4,this.CMD_SEL_1K_VROM_1C00=5,this.CMD_SEL_ROM_PAGE1=6,this.CMD_SEL_ROM_PAGE2=7,this.command=null,this.prgAddressSelect=null,this.chrAddressSelect=null,this.pageNumber=null,this.irqCounter=null,this.irqLatchValue=null,this.irqEnable=null,this.prgAddressChanged=!1},JSNES.Mappers[4].prototype=new JSNES.Mappers[0],JSNES.Mappers[4].prototype.write=function(e,t){if(e<32768)JSNES.Mappers[0].prototype.write.apply(this,arguments);else switch(e){case 32768:this.command=7&t;var s=t>>6&1;s!=this.prgAddressSelect&&(this.prgAddressChanged=!0),this.prgAddressSelect=s,this.chrAddressSelect=t>>7&1;break;case 32769:this.executeCommand(this.command,t);break;case 40960:0!=(1&t)?this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING):this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING);break;case 40961:break;case 49152:this.irqCounter=t;break;case 49153:this.irqLatchValue=t;break;case 57344:this.irqEnable=0;break;case 57345:this.irqEnable=1}},JSNES.Mappers[4].prototype.executeCommand=function(e,t){switch(e){case this.CMD_SEL_2_1K_VROM_0000:0===this.chrAddressSelect?(this.load1kVromBank(t,0),this.load1kVromBank(t+1,1024)):(this.load1kVromBank(t,4096),this.load1kVromBank(t+1,5120));break;case this.CMD_SEL_2_1K_VROM_0800:0===this.chrAddressSelect?(this.load1kVromBank(t,2048),this.load1kVromBank(t+1,3072)):(this.load1kVromBank(t,6144),this.load1kVromBank(t+1,7168));break;case this.CMD_SEL_1K_VROM_1000:0===this.chrAddressSelect?this.load1kVromBank(t,4096):this.load1kVromBank(t,0);break;case this.CMD_SEL_1K_VROM_1400:0===this.chrAddressSelect?this.load1kVromBank(t,5120):this.load1kVromBank(t,1024);break;case this.CMD_SEL_1K_VROM_1800:0===this.chrAddressSelect?this.load1kVromBank(t,6144):this.load1kVromBank(t,2048);break;case this.CMD_SEL_1K_VROM_1C00:0===this.chrAddressSelect?this.load1kVromBank(t,7168):this.load1kVromBank(t,3072);break;case this.CMD_SEL_ROM_PAGE1:this.prgAddressChanged&&(0===this.prgAddressSelect?this.load8kRomBank(2*(this.nes.rom.romCount-1),49152):this.load8kRomBank(2*(this.nes.rom.romCount-1),32768),this.prgAddressChanged=!1),0===this.prgAddressSelect?this.load8kRomBank(t,32768):this.load8kRomBank(t,49152);break;case this.CMD_SEL_ROM_PAGE2:this.load8kRomBank(t,40960),this.prgAddressChanged&&(0===this.prgAddressSelect?this.load8kRomBank(2*(this.nes.rom.romCount-1),49152):this.load8kRomBank(2*(this.nes.rom.romCount-1),32768),this.prgAddressChanged=!1)}},JSNES.Mappers[4].prototype.loadROM=function(e){this.nes.rom.valid?(this.load8kRomBank(2*(this.nes.rom.romCount-1),49152),this.load8kRomBank(2*(this.nes.rom.romCount-1)+1,57344),this.load8kRomBank(0,32768),this.load8kRomBank(1,40960),this.loadCHRROM(),this.loadBatteryRam(),this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET)):alert("MMC3: Invalid ROM! Unable to load.")},JSNES.Mappers[4].prototype.clockIrqCounter=function(){1==this.irqEnable&&(this.irqCounter--,this.irqCounter<0&&(this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL),this.irqCounter=this.irqLatchValue))},JSNES.Mappers[4].prototype.toJSON=function(){var e=JSNES.Mappers[0].prototype.toJSON.apply(this);return e.command=this.command,e.prgAddressSelect=this.prgAddressSelect,e.chrAddressSelect=this.chrAddressSelect,e.pageNumber=this.pageNumber,e.irqCounter=this.irqCounter,e.irqLatchValue=this.irqLatchValue,e.irqEnable=this.irqEnable,e.prgAddressChanged=this.prgAddressChanged,e},JSNES.Mappers[4].prototype.fromJSON=function(e){JSNES.Mappers[0].prototype.fromJSON.apply(this,e),this.command=e.command,this.prgAddressSelect=e.prgAddressSelect,this.chrAddressSelect=e.chrAddressSelect,this.pageNumber=e.pageNumber,this.irqCounter=e.irqCounter,this.irqLatchValue=e.irqLatchValue,this.irqEnable=e.irqEnable,this.prgAddressChanged=e.prgAddressChanged},JSNES.Mappers[5]=function(e){this.nes=e},JSNES.Mappers[5].prototype=new JSNES.Mappers[0],JSNES.Mappers[5].prototype.write=function(e,t){e<32768?JSNES.Mappers[0].prototype.write.apply(this,arguments):this.load8kVromBank(t,0)},JSNES.Mappers[5].prototype.write=function(e,t){if(e<20480)JSNES.Mappers[0].prototype.write.apply(this,arguments);else switch(e){case 20736:this.prg_size=3&t;break;case 20737:this.chr_size=3&t;break;case 20738:this.sram_we_a=3&t;break;case 20739:this.sram_we_b=3&t;break;case 20740:this.graphic_mode=3&t;break;case 20741:this.nametable_mode=t,this.nametable_type[0]=3&t,this.load1kVromBank(3&t,8192),this.nametable_type[1]=3&(t>>=2),this.load1kVromBank(3&t,9216),this.nametable_type[2]=3&(t>>=2),this.load1kVromBank(3&t,10240),this.nametable_type[3]=3&(t>>=2),this.load1kVromBank(3&t,11264);break;case 20742:this.fill_chr=t;break;case 20743:this.fill_pal=3&t;break;case 20755:this.SetBank_SRAM(3,3&t);break;case 20756:case 20757:case 20758:case 20759:this.SetBank_CPU(e,t);break;case 20768:case 20769:case 20770:case 20771:case 20772:case 20773:case 20774:case 20775:this.chr_mode=0,this.chr_page[0][7&e]=t,this.SetBank_PPU();break;case 20776:case 20777:case 20778:case 20779:this.chr_mode=1,this.chr_page[1][3&e]=t,this.chr_page[1][4+(3&e)]=t,this.SetBank_PPU();break;case 20992:this.split_control=t;break;case 20993:this.split_scroll=t;break;case 20994:this.split_page=63&t;break;case 20995:this.irq_line=t,this.nes.cpu.ClearIRQ();break;case 20996:this.irq_enable=t,this.nes.cpu.ClearIRQ();break;case 20997:this.mult_a=t;break;case 20998:this.mult_b=t;break;default:20480<=e&&e<=20501?this.nes.papu.exWrite(e,t):23552<=e&&e<=24575?2!==this.graphic_mode&&3!==this.graphic_mode&&this.irq_status:24576<=e&&e<=32767&&2===this.sram_we_a&&this.sram_we_b}},JSNES.Mappers[5].prototype.loadROM=function(){if(!this.nes.rom.valid)throw new Error("UNROM: Invalid ROM! Unable to load.");this.load8kRomBank(2*this.nes.rom.romCount-1,32768),this.load8kRomBank(2*this.nes.rom.romCount-1,40960),this.load8kRomBank(2*this.nes.rom.romCount-1,49152),this.load8kRomBank(2*this.nes.rom.romCount-1,57344),this.loadCHRROM(),this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET)},JSNES.Mappers[7]=function(e){this.nes=e},JSNES.Mappers[7].prototype=new JSNES.Mappers[0],JSNES.Mappers[7].prototype.write=function(e,t){e<32768?JSNES.Mappers[0].prototype.write.apply(this,arguments):(this.load32kRomBank(7&t,32768),16&t?this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING2):this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING))},JSNES.Mappers[7].prototype.loadROM=function(){if(!this.nes.rom.valid)throw new Error("AOROM: Invalid ROM! Unable to load.");this.loadPRGROM(),this.loadCHRROM(),this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET)},JSNES.Mappers[11]=function(e){this.nes=e},JSNES.Mappers[11].prototype=new JSNES.Mappers[0],JSNES.Mappers[11].prototype.write=function(e,t){var s,r;e<32768?JSNES.Mappers[0].prototype.write.apply(this,arguments):(r=2*(15&t)%this.nes.rom.romCount,s=(2*(15&t)+1)%this.nes.rom.romCount,this.loadRomBank(r,32768),this.loadRomBank(s,49152),0<this.nes.rom.vromCount&&(r=2*(t>>4)%this.nes.rom.vromCount,this.loadVromBank(r,0),this.loadVromBank(1+r,4096)))},JSNES.Mappers[34]=function(e){this.nes=e},JSNES.Mappers[34].prototype=new JSNES.Mappers[0],JSNES.Mappers[34].prototype.write=function(e,t){e<32768?JSNES.Mappers[0].prototype.write.apply(this,arguments):this.load32kRomBank(t,32768)},JSNES.Mappers[66]=function(e){this.nes=e,console.log("Mapper 66")},JSNES.Mappers[66].prototype=new JSNES.Mappers[0],JSNES.Mappers[66].prototype.write=function(e,t){e<32768?JSNES.Mappers[0].prototype.write.apply(this,arguments):(this.load32kRomBank(t>>4&3,32768),this.load8kVromBank(2*(3&t),0))};